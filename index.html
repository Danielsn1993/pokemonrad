<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
  <meta name="screen-orientation" content="portrait">
  <meta name="x5-orientation" content="portrait">
  <title>PokemonRad</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Press Start 2P', monospace, Arial;
      background: #000;
      color: #fff;
      font-size: 20px;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      touch-action: manipulation;
    }

    .container {
      width: 100%;
      max-width: 600px; /* DEFINA O TAMANHO MÁXIMO AQUI */
      margin: 0 auto; /* CENTRALIZA */
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .screen {
      position: relative;
      display: none;
      background: #f0f0f0;
      border: 3px solid #000;
      color: #000;
      min-height: 100vh;
      padding: 10px;
    }

    #map-screen {
      padding: 50px 10px 10px 10px;
    }

    .screen.active {
      display: block;
    }

    h1 {
      text-align: center;
      font-size: 32px;
      margin-bottom: 10px;
      color: #ffcc00;
      text-shadow: 2px 2px #000;
    }

    h2 {
      font-size: 24px;
      margin: 10px 0;
      color: #cc0000;
    }

    h3 {
      font-size: 20px;
    }

    .starter-selection {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      gap: 5px;
    }

    .starter-card {
      text-align: center;
      padding: 8px;
      border: 3px solid #333;
      border-radius: 5px;
      background: #f0f0f0;
      flex: 1;
      touch-action: manipulation;
    }

    .starter-card:active {
      transform: scale(0.95);
      border-color: #ffcc00;
      background: #fff;
    }

    .starter-card img {
      width: 60px;
      height: 60px;
    }

    .starter-card p {
      margin-top: 5px;
      font-size: 14px;
      line-height: 1.4;
    }

    .map-container {
      background-image: url('pokemon_assets/images/mapa.png');
      background-size: cover;
      background-position: center;
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      min-height: 200px;
      position: relative;
    }

    .gym-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .gym-badge {
      background: rgba(255, 255, 255, 0.9);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 8px;
      font-size: 16px;
      touch-action: manipulation;
    }

    .gym-badge:active {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    .gym-badge.completed {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #ff8800;
    }

    .gym-badge.locked {
      opacity: 0.5;
    }

    .pokemon-center-icon {
      width: 150px;
      height: 150px;
      position: static;
      display: block;
      margin: 10px auto;
      transform: scale(1);
      touch-action: manipulation;
      order: 4;
    }

    .pokemon-center-icon:active {
      transform: scale(1.05);
    }

    .player-info {
      background: rgba(0, 0, 0, 0.85);
      border: 3px solid #ffcc00;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      color: #fff;
      font-size: 18px;
      position: relative;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .player-info > h2 {
      order: 1;
      width: 100%;
    }

    .battle-player-info {
      background: rgba(0, 0, 0, 0.85);
      border: 1cqw solid #ffcc00;
      border-radius: 1.8cqw;
      padding: 1cqw;
      margin-bottom: 1.4cqw;
      color: #fff;
      container-type: inline-size;
      font-size: 2cqw;
      position: absolute;
      width: 37%;
      height: auto;
      right: 2%;
      bottom: 2%;
    }

    .opponent-info {
      background: rgba(255, 0, 0, 0.85);
      border: 1cqw solid #000;
      border-radius: 1.8cqw;
      padding: 1cqw;
      color: #fff;
      margin-bottom: 1.4cqw;
      container-type: inline-size;
      font-size: 2cqw;
      position: absolute;
      width: 45%;
      height: auto;
      left: 2%;
      top: 2%;
    }

    .battle-stat-bar {
      background: #333;
      height: 2.2cqh;
      border: 1cqw solid #000;
      border-radius: 1.8cqw;
      overflow: hidden;
      margin: 0.4cqh 0;
      max-width: 90%;
    }

    .battle-stat-bar .stat-fill {
      height: 100%;
    }

    .pokemon-display {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px auto;
      justify-content: center;
      order: 2;
    }

    .pokemon-display img.starter-small {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .pokemon-display img.mid-small {
      width: 110px;
      height: 110px;
      flex-shrink: 0;
    }

    .pokemon-display img.final-small {
      width: 150px;
      height: 150px;
      flex-shrink: 0;
    }


    .stats {
      flex: 1;
      text-align: center;
    }

    .stat-bar {
      background: #333;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin: 4px auto; /* MUDE DE "4px 0" PARA "4px auto" - centraliza a barra */
      border: 2px solid #000;
      max-width: 120px;
    }

    .stat-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #00cc00);
      transition: width 0.5s;
    }

    .exp-fill {
      background: linear-gradient(90deg, #ffcc00, #ff8800);
    }

    .potion-container {
      text-align: center;
      margin: 10px 0;
      padding: 8px;
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #fff;
      border-radius: 5px;
    }

    .potion-container button {
      font-size: 18px;
      min-width: 120px;
    }

    .battle-pokemon-container {
      background-image: url('pokemon_assets/images/battle_bg.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #000;
      border-radius: 5px;
      margin-bottom: 10px;
      position: relative;
      width: 100%;
      max-width: 1000px; /* Ajuste esse valor para mudar o tamanho */
      margin-left: auto;
      margin-right: auto;
      aspect-ratio: 896 / 1152;
      overflow: hidden;
    }

    .pokemon-sprite {
      text-align: center;
      position: absolute;
      width: 37%;
    }

    .player-sprite {
      left: 7%;
      bottom: 0%;
    }

    .opponent-sprite {
      right: 7%;
      top: 35%;
    }

    .pokemon-sprite img {
      width: 60%;      /* ← Imagem ocupa 60% do container */
      height: auto;    /* ← Mantém proporção */
      max-width: 150px; /* ← Limite máximo */
      object-fit: contain; /* ← Não corta a imagem */
    }

    .question-box {
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #fff;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 18px;
      color: #fff;
    }

    .question-box h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #fff;
      line-height: 1.4;
    }

    .answers {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 8px;
    }

    button {
      background: #ffcc00;
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 18px;
      color: #000;
      font-weight: bold;
      touch-action: manipulation;
      min-height: 44px;
    }

    button:active {
      background: #ffed4e;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
    }

    .message-box {
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid #fff;
      border-radius: 5px;
      padding: 10px;
      color: #fff;
      margin: 10px 0;
      min-height: 50px;
      font-size: 18px;
      line-height: 1.5;
    }

    .training-area {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 18px;
    }

    .btn-primary {
      background: #cc0000;
      color: #fff;
    }

    .btn-primary:active {
      background: #ff0000;
    }

    .btn-secondary {
      background: #0066cc;
      color: #fff;
    }

    .btn-secondary:active {
      background: #0088ff;
    }

    .btn-reset {
      position: absolute;
      background: #cc0000;
      color: #fff;
      font-size: 14px;
      padding: 6px 8px;
      top: 5px;
      right: 5px;
      min-height: 30px;
    }

    .btn-reset:active {
      background: #ff0000;
    }

    .btn-export {
      background: #00aa00;
      color: #fff;
      font-size: 16px;
      padding: 6px 8px;
      position: absolute;
      top: 5px;
      left: 5px;
      min-height: 30px;
    }

    .btn-export:active {
      background: #00cc00;
    }

    .btn-import {
      background: #0066cc;
      color: #fff;
      font-size: 16px;
      padding: 6px 8px;
      position: absolute;
      top: 5px;
      left: 90px;
      min-height: 30px;
    }

    .btn-import:active {
      background: #0088ff;
    }

    .badges-display {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
      justify-content: center;
      order: 3;
    }

    .badge-icon {
      width: 28px;
      height: 28px;
      background: #555;
      border: 2px solid #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .badge-icon.earned {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
    }

    .elite-section {
      background: rgba(138, 43, 226, 0.9);
      border: 3px solid #ffd700;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
    }

    .elite-section h2 {
      color: #ffd700;
      font-size: 28px;
      text-shadow: 2px 2px #000;
      margin-bottom: 8px;
    }

    .elite-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .elite-card {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      touch-action: manipulation;
    }

    .elite-card:active {
      transform: scale(0.98);
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
    }

    .elite-card.completed {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #8b00ff;
    }

    .elite-card.locked {
      opacity: 0.5;
    }

    .victory-screen {
      background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
      text-align: center;
      padding: 20px;
    }

    .victory-screen h1 {
      font-size: 40px;
      color: #8b00ff;
      text-shadow: 3px 3px #000;
      margin-bottom: 15px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .victory-screen p {
      font-size: 20px;
      margin: 10px 0;
      color: #000;
    }

    .evolution-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .evolution-overlay.active {
      display: flex;
    }

    .evolution-container {
      text-align: center;
      color: #fff;
      max-width: 90%;
      width: 100%;
      padding: 10px;
    }

    .evolution-container h2 {
      font-size: 28px;
      color: #ffcc00;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }

    .evolution-sprites {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
      min-height: 100px;
    }

    .evolution-sprite {
      position: relative;
    }

    .evolution-sprite img {
      width: 80px;
      height: 80px;
    }

    .evolution-arrow {
      font-size: 24px;
      color: #ffcc00;
      animation: slideRight 1s infinite;
    }

    @keyframes slideRight {
      0%, 100% { transform: translateX(-5px); opacity: 0.5; }
      50% { transform: translateX(5px); opacity: 1; }
    }

    .evolution-flash {
      animation: evolutionFlash 0.3s ease-in-out;
    }

    @keyframes evolutionFlash {
      0%, 100% { opacity: 1; filter: brightness(1); }
      50% { opacity: 0.3; filter: brightness(3); }
    }

    .evolution-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .evolution-buttons button {
      min-width: 100px;
      font-size: 18px;
    }

    .battle-result-overlay {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .battle-result-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .battle-result-message {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border: 5px solid;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
      animation: zoomIn 0.5s ease-out;
      max-width: 90%;
    }

    .battle-result-message.victory {
      border-color: #ffd700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
    }

    .battle-result-message.defeat {
      border-color: #cc0000;
      box-shadow: 0 0 30px rgba(204, 0, 0, 0.6);
    }

    @keyframes zoomIn {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .battle-result-message h1 {
      font-size: 40px;
      margin-bottom: 10px;
      text-shadow: 3px 3px #000;
      animation: pulse 2s infinite;
      line-height: 1.3;
    }

    .battle-result-message.victory h1 {
      color: #ffd700;
    }

    .battle-result-message.defeat h1 {
      color: #ff3333;
    }

    .battle-result-message p {
      font-size: 20px;
      color: #fff;
      margin-top: 8px;
      line-height: 1.4;
    }

    .question-counter {
      background: rgba(255, 215, 0, 0.9);
      border: 2px solid #000;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 16px;
      color: #000;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 8px;
    }

    .image-preview {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.95);
      padding: 0;
      box-shadow: none;
      border: none;
      border-radius: 0;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0;
    }

    .image-preview.active {
      display: block;
    }

    .close-preview {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #cc0000;
      color: #fff;
      border: 2px solid #000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      min-height: unset;
      padding: 0;
    }

    .close-preview:active {
      background: #ff0000;
      transform: scale(1.1);
    }

    .image-link {
      color: #ffcc00;
      text-decoration: underline;
      margin-bottom: 10px;
      display: inline-block;
      font-size: 24px;
      touch-action: manipulation;
    }

    .image-link:active {
      color: #fff;
    }

    /* Força o jogo a sempre aparecer em portrait, não importa a orientação do celular */
    @media screen and (orientation: landscape) {
      html {
        transform: rotate(-90deg);
        transform-origin: left top;
        width: 100vh;
        overflow-x: hidden;
        position: absolute;
        top: 100%;
        left: 0;
      }
      
      body {
        height: 100vw;
        width: 100vh;
        overflow: hidden;
      }
    }
  </style>
</head>
<body>
  <div id="image-preview" class="image-preview">
    <div class="close-preview" onclick="hideImagePreview()">✕</div>
    <img id="preview-img" src="" alt="Preview">
  </div>

  <div id="battle-result-overlay" class="battle-result-overlay">
    <div id="battle-result-message" class="battle-result-message">
      <h1 id="battle-result-title"></h1>
      <p id="battle-result-text"></p>
    </div>
  </div>

  <div id="evolution-overlay" class="evolution-overlay">
    <div class="evolution-container">
      <h2 id="evolution-title">O QUÊ?</h2>
      <div class="evolution-sprites">
        <div class="evolution-sprite">
          <img id="evolution-from-sprite" src="" alt="Pokemon Atual">
          <p id="evolution-from-name" style="margin-top: 8px; font-size: 18px;"></p>
        </div>
        <div class="evolution-arrow">➜</div>
        <div class="evolution-sprite">
          <img id="evolution-to-sprite" src="" alt="Pokemon Evoluído">
          <p id="evolution-to-name" style="margin-top: 8px; font-size: 18px;"></p>
        </div>
      </div>
      <p id="evolution-message" style="font-size: 18px; margin: 10px 0;"></p>
      <div class="evolution-buttons" id="evolution-choice" style="display: none;">
        <button onclick="confirmEvolution()" class="btn-primary">Sim, evoluir!</button>
        <button onclick="cancelEvolution()" class="btn-secondary">Não, cancelar</button>
      </div>
    </div>
  </div>

  <audio id="map-music" loop preload="auto">
    <source src="pokemon_assets/audio/music1.mp3" type="audio/mpeg">
  </audio>
  <audio id="training-music" loop preload="auto">
    <source src="pokemon_assets/audio/music2.mp3" type="audio/mpeg">
  </audio>
  <audio id="gym-music" loop preload="auto">
    <source src="pokemon_assets/audio/music3.mp3" type="audio/mpeg">
  </audio>
  <audio id="elite-music" loop preload="auto">
    <source src="pokemon_assets/audio/music4.mp3" type="audio/mpeg">
  </audio>

  <div class="container">
    <div id="starter-screen" class="screen">
      <h1>🎮 POKEMONRAD 🎮</h1>
      <h2>Escolha seu Pokemon Inicial:</h2>
      <div class="starter-selection">
        <div class="starter-card" onclick="selectStarter('bulbasaur')">
          <img src="pokemon_assets/sprites_front/bulbasaur.gif" alt="Bulbasaur">
          <p><strong>BULBASAUR</strong><br>Tipo: Grama/Venenoso</p>
        </div>
        <div class="starter-card" onclick="selectStarter('charmander')">
          <img src="pokemon_assets/sprites_front/charmander.gif" alt="Charmander">
          <p><strong>CHARMANDER</strong><br>Tipo: Fogo</p>
        </div>
        <div class="starter-card" onclick="selectStarter('squirtle')">
          <img src="pokemon_assets/sprites_front/squirtle.gif" alt="Squirtle">
          <p><strong>SQUIRTLE</strong><br>Tipo: Água</p>
        </div>
      </div>
    </div>

    <div id="map-screen" class="screen">
      <button onclick="resetGame()" class="btn-reset">Resetar</button>
      <button onclick="exportSave()" class="btn-export">💾 Save</button>
      <button onclick="importSave()" class="btn-import">📁 Load</button>
      <input type="file" id="file-input" accept=".txt" style="display: none;" onchange="loadSaveFile(event)">
      <h1>🗺️ MAPA DE KANTO 🗺️</h1>
      
      <div class="player-info">
        <h2>🧪 Poções: <span id="potion-count">0</span></h2>
        <div class="pokemon-display">
          <img id="player-sprite" src="" alt="Seu Pokemon">
          <div class="stats">
            <p><strong id="player-pokemon-name">---</strong> - Nível <span id="player-level">1</span></p>
            <div class="stat-bar">
              <div class="stat-fill" id="hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="hp-display">15/15</span></p>
            <div class="stat-bar">
              <div class="stat-fill exp-fill" id="exp-bar" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="exp-display">0/50</span></p>
          </div>
        </div>

        <img src="pokemon_assets/images/pokemon_center.png" 
            alt="Pokemon Center" 
            class="pokemon-center-icon" 
            onclick="healPokemon()"
            title="Clique para curar seu Pokemon">

        <div class="badges-display">
          <div class="badge-icon" id="badge-0" title="Boulder Badge">🪨</div>
          <div class="badge-icon" id="badge-1" title="Cascade Badge">💧</div>
          <div class="badge-icon" id="badge-2" title="Thunder Badge">⚡</div>
          <div class="badge-icon" id="badge-3" title="Rainbow Badge">🌈</div>
          <div class="badge-icon" id="badge-4" title="Soul Badge">☠️</div>
          <div class="badge-icon" id="badge-5" title="Marsh Badge">🧠</div>
          <div class="badge-icon" id="badge-6" title="Volcano Badge">🔥</div>
          <div class="badge-icon" id="badge-7" title="Earth Badge">🌍</div>
        </div>
      </div>

      <div class="training-area">
        <h2>💪 Área de Treino</h2>
        <p style="margin: 8px 0;">Resolva questões para ganhar EXP e subir de nível! Cuidado: erros fazem você perder vida (HP) em batalhas e perder EXP.</p>
        <button onclick="startTraining()" class="btn-secondary">Treinar Agora</button>
      </div>

      <h2 style="margin-top: 10px; text-align: center;">GINÁSIOS DE KANTO</h2>
      <div class="gym-grid">
        <div class="gym-badge" id="gym-0" onclick="challengeGym(0)">
          <h3>🪨 PEWTER CITY</h3>
          <p style="margin-top: 5px;">Líder: Brock<br>Nível Recomendado: 10</p>
        </div>
        <div class="gym-badge locked" id="gym-1" onclick="challengeGym(1)">
          <h3>💧 CERULEAN CITY</h3>
          <p style="margin-top: 5px;">Líder: Misty<br>Nível Recomendado: 18</p>
        </div>
        <div class="gym-badge locked" id="gym-2" onclick="challengeGym(2)">
          <h3>⚡ VERMILION CITY</h3>
          <p style="margin-top: 5px;">Líder: Lt. Surge<br>Nível Recomendado: 25</p>
        </div>
        <div class="gym-badge locked" id="gym-3" onclick="challengeGym(3)">
          <h3>🌈 CELADON CITY</h3>
          <p style="margin-top: 5px;">Líder: Erika<br>Nível Recomendado: 30</p>
        </div>
        <div class="gym-badge locked" id="gym-4" onclick="challengeGym(4)">
          <h3>☠️ FUCHSIA CITY</h3>
          <p style="margin-top: 5px;">Líder: Koga<br>Nível Recomendado: 35</p>
        </div>
        <div class="gym-badge locked" id="gym-5" onclick="challengeGym(5)">
          <h3>🧠 SAFFRON CITY</h3>
          <p style="margin-top: 5px;">Líder: Sabrina<br>Nível Recomendado: 38</p>
        </div>
        <div class="gym-badge locked" id="gym-6" onclick="challengeGym(6)">
          <h3>🔥 CINNABAR ISLAND</h3>
          <p style="margin-top: 5px;">Líder: Blaine<br>Nível Recomendado: 42</p>
        </div>
        <div class="gym-badge locked" id="gym-7" onclick="challengeGym(7)">
          <h3>🌍 VIRIDIAN CITY</h3>
          <p style="margin-top: 5px;">Líder: Giovanni<br>Nível Recomendado: 45</p>
        </div>
      </div>

      <div class="elite-section" id="elite-section" style="display: none;">
        <h2>👑 ELITE FOUR 👑</h2>
        <p style="font-size: 18px; color: #fff; margin: 10px 0;">Você conquistou todas as 8 insígnias!<br>Agora enfrente a Elite Four!</p>
        <div class="elite-grid">
          <div class="elite-card locked" id="elite-0" onclick="challengeElite(0)">
            <h3>❄️ LORELEI</h3>
            <p style="margin-top: 5px;">Elite Four #1<br>Mestre de Gelo<br>Nível Recomendado: 50</p>
          </div>
          <div class="elite-card locked" id="elite-1" onclick="challengeElite(1)">
            <h3>👊 BRUNO</h3>
            <p style="margin-top: 5px;">Elite Four #2<br>Mestre de Luta<br>Nível Recomendado: 55</p>
          </div>
          <div class="elite-card locked" id="elite-2" onclick="challengeElite(2)">
            <h3>👻 AGATHA</h3>
            <p style="margin-top: 5px;">Elite Four #3<br>Mestre Fantasma<br>Nível Recomendado: 60</p>
          </div>
          <div class="elite-card locked" id="elite-3" onclick="challengeElite(3)">
            <h3>🐉 LANCE</h3>
            <p style="margin-top: 5px;">Elite Four #4<br>Mestre de Dragões<br>Nível Recomendado: 75</p>
          </div>
          <div class="elite-card locked" id="elite-4" onclick="challengeElite(4)" style="grid-column: 1 / -1;">
            <h3>🏆 ASH (CAMPEÃO)</h3>
            <p style="margin-top: 5px;">Batalha Final<br>Ash<br>Nível Recomendado: 100</p>
          </div>
        </div>
      </div>
    </div>

    <div id="training-screen" class="screen">
      <h1>💪 TREINO POKEMON 💪</h1>
      
      <div class="battle-pokemon-container">
          <div class="opponent-info">
            <p><strong id="training-opponent-name">Pokemon Selvagem</strong></p>
            <p><span id="training-opponent-pokemon-name">Pokemon</span> - Nível <span id="training-opponent-level">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="training-opponent-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="training-opponent-hp-display">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="training-player-sprite" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="training-opponent-sprite" src="" alt="Pokemon Selvagem">
          </div>

          <div class="battle-player-info">
            <p><span id="training-pokemon-name">---</span> Lv.<span id="training-level">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="training-battle-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="training-battle-hp-display">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="training-exp-bar" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="training-exp-display">0/50</span></p>
          </div>
      </div>

      <div class="message-box" id="training-message">
        Responda corretamente para atacar o Pokemon selvagem!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('training')" id="training-potion-btn">
          🧪 Usar Poção (<span id="training-potion-count">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="training-counter">Questões: 0/0</div>
        <h3 id="training-question">Carregando questão...</h3>
        <div class="answers" id="training-answers"></div>
      </div>

      <div style="text-align: center;">
        <button onclick="backToMap()" class="btn-secondary">Voltar ao Mapa</button>
      </div>
    </div>

    <div id="battle-screen" class="screen">
      <h1>⚔️ BATALHA POKEMON ⚔️</h1>
      
      <div class="battle-pokemon-container">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name">Pokemon</span> - Nível <span id="opponent-level">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name">---</span> Lv.<span id="battle-player-level">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message">
        Responda corretamente para atacar o pokemon do líder do ginásio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle')" id="battle-potion-btn">
          🧪 Usar Poção (<span id="battle-potion-count">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter">Questões: 0/0</div>
        <h3 id="battle-question">Carregando questão...</h3>
        <div class="answers" id="battle-answers"></div>
      </div>
    </div>

    <div id="victory-screen" class="screen victory-screen">
      <h1>🎉 PARABÉNS! 🎉</h1>
      <p style="font-size: 24px; margin: 15px 0;">VOCÊ SE TORNOU O</p>
      <h1 style="font-size: 44px;">MESTRE POKEMON!</h1>
      <p style="font-size: 20px; margin: 15px 0;">Você derrotou todos os líderes de ginásio<br>e a Elite Four!</p>
      <p style="font-size: 24px; margin: 20px 0;">🏆 JOGO COMPLETO 🏆</p>
      <button onclick="resetGame()" style="font-size: 20px; margin-top: 15px;">Jogar Novamente</button>
    </div>
  </div>

  <script>
    const game = {
      player: {
        pokemon: null,
        level: 1,
        exp: 0,
        expToNext: 50,
        maxHp: 15,
        hp: 15,
        badges: [],
        eliteDefeated: [],
        potions: 0
      },
      currentGym: null,
      currentElite: null,
      currentOpponent: null,
      inBattle: false,
      battleType: 'gym',
      trainingOpponent: null,
      questionsAnswered: 0,
      pendingEvolution: null
    };

    const audioSystem = {
      currentAudio: null,
      fadeInDuration: 2000,
      
      stopAll() {
        const audios = ['map-music', 'training-music', 'gym-music', 'elite-music'];
        audios.forEach(id => {
          const audio = document.getElementById(id);
          audio.pause();
          audio.currentTime = 0;
          audio.volume = 0;
        });
        this.currentAudio = null;
      },
      
      play(audioId) {
        if (this.currentAudio === audioId) return;
        this.stopAll();
        const audio = document.getElementById(audioId);
        audio.volume = 0;
        audio.play().catch(e => console.log('Erro ao reproduzir áudio:', e));
        this.currentAudio = audioId;
        this.fadeIn(audio);
      },
      
      fadeIn(audio) {
        const steps = 20;
        const volumeIncrement = 1 / steps;
        const timeIncrement = this.fadeInDuration / steps;
        let currentStep = 0;
        
        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.min(currentStep * volumeIncrement, 1);
          if (currentStep >= steps) clearInterval(fadeInterval);
        }, timeIncrement);
      }
    };

    function showBattleResult(isVictory, title, subtitle) {
      const overlay = document.getElementById('battle-result-overlay');
      const message = document.getElementById('battle-result-message');
      const titleEl = document.getElementById('battle-result-title');
      const textEl = document.getElementById('battle-result-text');
      
      message.className = 'battle-result-message ' + (isVictory ? 'victory' : 'defeat');
      titleEl.textContent = title;
      textEl.textContent = subtitle;
      
      overlay.classList.add('active');
      
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 3000);
    }

    const rawQuestionsText = `

QUESTÃO 1
https://s3.amazonaws.com/brainscape-prod/system/cm/624/838/248/q_image_ios.?1756901518
Paciente apresenta inversão do fluxo da artéria vertebral esquerda. Qual a possibilidade diagnóstica?

A) Hipoplasia da artéria vertebral esquerda.
B) Hipoplasia da artéria vertebral direita.
C) Estenose da artéria subclávia esquerda.
D) Estenose da artéria subclávia direita.
E) AVC isquêmico em território de artéria basilar.
GABARITO: C

`;

    function parseQuestions(text) {
      const questions = [];
      const questionPattern = /QUESTÃO (\d+)/g;
      const matches = [...text.matchAll(questionPattern)];
      const questionBlocks = text.split(/QUESTÃO \d+/).filter(block => block.trim());
      
      questionBlocks.forEach((block, index) => {
        const lines = block.trim().split('\n').filter(line => line.trim());
        if (lines.length < 7) return;
        
        let questionText = '';
        let options = [];
        let correctAnswer = '';
        let hasImage = false;
        const questionNumber = matches[index] ? parseInt(matches[index][1]) : index + 1;
        
        lines.forEach(line => {
          line = line.trim();
          
          if (line.startsWith('http://') || line.startsWith('https://')) {
            hasImage = true;
            return;
          }
          
          if (line.startsWith('A)')) options[0] = line.substring(2).trim();
          else if (line.startsWith('B)')) options[1] = line.substring(2).trim();
          else if (line.startsWith('C)')) options[2] = line.substring(2).trim();
          else if (line.startsWith('D)')) options[3] = line.substring(2).trim();
          else if (line.startsWith('E)')) options[4] = line.substring(2).trim();
          else if (line.toUpperCase().startsWith('GABARITO:')) correctAnswer = line.split(':')[1].trim().toUpperCase();
          else if (!line.startsWith('QUESTÃO') && options.length === 0) questionText += (questionText ? ' ' : '') + line;
        });
        
        if (hasImage) {
          questionText = `<span class="image-link" onclick="showImagePreviewAuto('questao_imagens/questao_${questionNumber}')" style="color: #ffcc00; text-decoration: underline; cursor: pointer; margin-bottom: 10px; display: inline-block; font-size: 24px;">🖼️VER IMAGEM</span><br>` + questionText;
        }
        
        if (questionText && options.length === 5 && correctAnswer) {
          const correctIndex = {'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4}[correctAnswer];
          questions.push({
            text: questionText,
            options: options,
            correctIndex: correctIndex,
            correctAnswer: options[correctIndex]
          });
        }
      });
      
      return questions;
    }

    let questionsBank = parseQuestions(rawQuestionsText);
    let usedQuestions = [];
    let currentTrainingQuestion = null;
    let currentBattleQuestion = null;

    function showImagePreview(url) {
      const preview = document.getElementById('image-preview');
      const img = document.getElementById('preview-img');
      img.src = url;
      preview.classList.add('active');
    }

    function hideImagePreview() {
      document.getElementById('image-preview').classList.remove('active');
    }

    function showImagePreviewAuto(basePath) {
      const extensions = ['.png', '.jpg', '.jpeg'];
      const img = document.getElementById('preview-img');
      const preview = document.getElementById('image-preview');
      
      function tryExtension(index) {
        if (index >= extensions.length) {
          alert('Imagem não encontrada! Verifique se o arquivo existe na pasta questao_imagens/');
          return;
        }
        
        img.src = basePath + extensions[index];
        img.onerror = function() {
          tryExtension(index + 1);
        };
        img.onload = function() {
          preview.classList.add('active');
        };
      }
      
      tryExtension(0);
    }

    function generateQuestion() {
      if (usedQuestions.length >= questionsBank.length) {
        usedQuestions = [];
        game.questionsAnswered = 0;
      }
      
      let availableIndexes = [];
      for (let i = 0; i < questionsBank.length; i++) {
        if (!usedQuestions.includes(i)) availableIndexes.push(i);
      }
      
      const randomIndex = availableIndexes[Math.floor(Math.random() * availableIndexes.length)];
      const selectedQuestion = questionsBank[randomIndex];
      const shuffledOptions = [...selectedQuestion.options];
      const correctAnswer = selectedQuestion.correctAnswer;
      
      for (let i = shuffledOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
      }
      
      return {
        question: selectedQuestion.text,
        answer: correctAnswer,
        allAnswers: shuffledOptions,
        index: randomIndex
      };
    }

    function markQuestionAsAnswered(questionIndex) {
      if (!usedQuestions.includes(questionIndex)) {
        usedQuestions.push(questionIndex);
        game.questionsAnswered++;
        saveUsedQuestions();
      }
    }

    function updateQuestionCounter() {
      const currentQuestionNumber = (currentTrainingQuestion || currentBattleQuestion) ? game.questionsAnswered + 1 : game.questionsAnswered;
      const counterText = `Questões: ${currentQuestionNumber}/${questionsBank.length}`;
      const trainingCounter = document.getElementById('training-counter');
      const battleCounter = document.getElementById('battle-counter');
      if (trainingCounter) trainingCounter.textContent = counterText;
      if (battleCounter) battleCounter.textContent = counterText;
    }

    function saveGame() {
      const saveData = {
        pokemon: game.player.pokemon,
        level: game.player.level,
        exp: game.player.exp,
        expToNext: game.player.expToNext,
        maxHp: game.player.maxHp,
        hp: game.player.hp,
        potions: game.player.potions,
        badges: game.player.badges,
        eliteDefeated: game.player.eliteDefeated,
        questionsAnswered: game.questionsAnswered,
        pendingEvolution: game.pendingEvolution,
        currentBattle: {
          inBattle: game.inBattle,
          battleType: game.battleType,
          currentGym: game.currentGym,
          currentElite: game.currentElite,
          currentOpponent: game.currentOpponent,
          trainingOpponent: game.trainingOpponent,
          currentQuestion: game.battleType === 'gym' || game.battleType === 'elite' ? currentBattleQuestion : currentTrainingQuestion
        }
      };
      localStorage.setItem('pokemonYellowSave', JSON.stringify(saveData));
    }

    function loadGame() {
      const saveData = localStorage.getItem('pokemonYellowSave');
      if (saveData) {
        const data = JSON.parse(saveData);
        game.player.pokemon = data.pokemon;
        game.player.level = data.level;
        game.player.exp = data.exp;
        game.player.expToNext = data.expToNext;
        game.player.potions = data.potions || 0;
        game.player.maxHp = data.maxHp;
        game.player.hp = data.hp;
        game.player.badges = data.badges || [];
        game.player.eliteDefeated = data.eliteDefeated || [];
        game.questionsAnswered = data.questionsAnswered || 0;
        game.pendingEvolution = data.pendingEvolution || null;
        
        if (data.currentBattle && data.currentBattle.inBattle) {
          game.inBattle = data.currentBattle.inBattle;
          game.battleType = data.currentBattle.battleType;
          game.currentGym = data.currentBattle.currentGym;
          game.currentElite = data.currentBattle.currentElite;
          game.currentOpponent = data.currentBattle.currentOpponent;
          game.trainingOpponent = data.currentBattle.trainingOpponent;
          
          if (data.currentBattle.currentQuestion) {
            if (game.battleType === 'training') {
              currentTrainingQuestion = data.currentBattle.currentQuestion;
            } else {
              currentBattleQuestion = data.currentBattle.currentQuestion;
            }
          }
        }
        
        return true;
      }
      return false;
    }

    function saveUsedQuestions() {
      localStorage.setItem('pokemonYellowUsedQuestions', JSON.stringify({
        used: usedQuestions,
        answered: game.questionsAnswered
      }));
    }

    function loadUsedQuestions() {
      const savedQuestions = localStorage.getItem('pokemonYellowUsedQuestions');
      if (savedQuestions) {
        const data = JSON.parse(savedQuestions);
        usedQuestions = data.used || [];
        game.questionsAnswered = data.answered || 0;
      }
    }

    function resetGame() {
      if (confirm('Tem certeza que deseja resetar todo o progresso?')) {
        localStorage.removeItem('pokemonYellowSave');
        localStorage.removeItem('pokemonYellowUsedQuestions');
        location.reload();
      }
    }

    function checkEvolution() {
      const currentPokemon = game.player.pokemon;
      const evolution = evolutionData[currentPokemon];
      
      if (evolution && game.player.level >= evolution.level) {
        game.pendingEvolution = evolution.evolvesTo;
        saveGame();
        return true;
      }
      return false;
    }

    function startEvolution() {
      if (!game.pendingEvolution) return;
      
      const fromPokemon = game.player.pokemon;
      const toPokemon = game.pendingEvolution;
      
      const overlay = document.getElementById('evolution-overlay');
      const title = document.getElementById('evolution-title');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      const fromSprite = document.getElementById('evolution-from-sprite');
      const toSprite = document.getElementById('evolution-to-sprite');
      const fromName = document.getElementById('evolution-from-name');
      const toName = document.getElementById('evolution-to-name');
      
      fromSprite.src = pokemonData[fromPokemon].frontSprite;
      toSprite.src = pokemonData[toPokemon].frontSprite;
      fromName.textContent = pokemonData[fromPokemon].name;
      toName.textContent = pokemonData[toPokemon].name;
      
      toSprite.style.opacity = '0';
      toName.style.opacity = '0';
      
      overlay.classList.add('active');
      title.textContent = 'O QUÊ?';
      message.textContent = `${pokemonData[fromPokemon].name} está evoluindo!`;
      choiceButtons.style.display = 'none';
      
      setTimeout(() => {
        fromSprite.classList.add('evolution-flash');
        
        setTimeout(() => {
          fromSprite.classList.remove('evolution-flash');
          
          setTimeout(() => {
            fromSprite.classList.add('evolution-flash');
            
            setTimeout(() => {
              fromSprite.classList.remove('evolution-flash');
              
              setTimeout(() => {
                fromSprite.classList.add('evolution-flash');
                
                setTimeout(() => {
                  fromSprite.style.opacity = '0';
                  fromName.style.opacity = '0';
                  toSprite.style.opacity = '1';
                  toName.style.opacity = '1';
                  
                  title.textContent = 'PARABÉNS!';
                  message.textContent = `${pokemonData[fromPokemon].name} evoluiu para ${pokemonData[toPokemon].name}!`;
                  
                  fromSprite.classList.remove('evolution-flash');
                  
                  setTimeout(() => {
                    message.textContent = `Deseja evoluir ${pokemonData[fromPokemon].name} para ${pokemonData[toPokemon].name}?`;
                    choiceButtons.style.display = 'flex';
                  }, 2000);
                }, 300);
              }, 500);
            }, 300);
          }, 500);
        }, 300);
      }, 1000);
    }

    function confirmEvolution() {
      const fromPokemon = game.player.pokemon;
      const toPokemon = game.pendingEvolution;
      
      game.player.pokemon = toPokemon;
      game.pendingEvolution = null;
      
      const overlay = document.getElementById('evolution-overlay');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      message.textContent = `${pokemonData[fromPokemon].name} evoluiu para ${pokemonData[toPokemon].name}!`;
      choiceButtons.style.display = 'none';
      
      saveGame();
      updatePlayerDisplay();
      updateGymAvailability();
      
      setTimeout(() => {
        overlay.classList.remove('active');
        document.getElementById('evolution-from-sprite').style.opacity = '1';
        document.getElementById('evolution-from-name').style.opacity = '1';
      }, 2000);
    }

    function cancelEvolution() {
      game.pendingEvolution = null;
      
      const overlay = document.getElementById('evolution-overlay');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      message.textContent = 'Evolução cancelada!';
      choiceButtons.style.display = 'none';
      
      saveGame();
      updateGymAvailability();
      
      setTimeout(() => {
        overlay.classList.remove('active');
        document.getElementById('evolution-from-sprite').style.opacity = '1';
        document.getElementById('evolution-from-name').style.opacity = '1';
      }, 1500);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadUsedQuestions();
      if (loadGame()) {
        if (game.inBattle) {
          if (game.battleType === 'training' && game.trainingOpponent) {
            showScreen('training-screen');
            audioSystem.play('training-music');
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('training-player-sprite').src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('training-player-sprite'), game.player.pokemon, true);
            document.getElementById('training-pokemon-name').textContent = playerData.name;
            document.getElementById('training-level').textContent = game.player.level;
            
            const opponentData = pokemonData[game.trainingOpponent.name];
            document.getElementById('training-opponent-name').textContent = 'Pokemon Selvagem';
            document.getElementById('training-opponent-pokemon-name').textContent = opponentData.name;
            document.getElementById('training-opponent-level').textContent = game.trainingOpponent.level;
            document.getElementById('training-opponent-sprite').src = opponentData.sprite;
            applyPokemonScaleInBattle(document.getElementById('training-opponent-sprite'), game.trainingOpponent.name, false);
            
            updateTrainingDisplay();
            nextTrainingQuestion();
          } else if (game.battleType === 'gym' && game.currentGym !== null) {
            const gym = gyms[game.currentGym];
            showScreen('battle-screen');
            audioSystem.play('gym-music');
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('battle-player-sprite').src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-player-sprite'), game.player.pokemon, true);
            document.getElementById('battle-player-name').textContent = playerData.name;
            document.getElementById('battle-player-level').textContent = game.player.level;
            document.getElementById('battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
            
            const hpPercent = (game.player.hp / game.player.maxHp) * 100;
            document.getElementById('battle-hp-bar').style.width = hpPercent + '%';
            
            const opponentPokemon = pokemonData[game.currentOpponent.name];
            document.getElementById('opponent-name').textContent = `Líder ${gym.name}`;
            document.getElementById('opponent-pokemon-name').textContent = opponentPokemon.name;
            document.getElementById('opponent-level').textContent = game.currentOpponent.level;
            document.getElementById('opponent-hp-display').textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
            document.getElementById('battle-opponent-sprite').src = opponentPokemon.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite'), game.currentOpponent.name, false);
            
            const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
            document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
            
            document.getElementById('battle-message').innerHTML = `${gym.name} desafia você para uma batalha!`;
            
            nextBattleQuestion();
          } else if (game.battleType === 'elite' && game.currentElite !== null) {
            const elite = eliteFour[game.currentElite];
            showScreen('battle-screen');
            audioSystem.play('elite-music');
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('battle-player-sprite').src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-player-sprite'), game.player.pokemon, true);
            document.getElementById('battle-player-name').textContent = playerData.name;
            document.getElementById('battle-player-level').textContent = game.player.level;
            document.getElementById('battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
            
            const hpPercent = (game.player.hp / game.player.maxHp) * 100;
            document.getElementById('battle-hp-bar').style.width = hpPercent + '%';
            
            const opponentPokemon = pokemonData[game.currentOpponent.name];
            document.getElementById('opponent-name').textContent = `${elite.name} - ${elite.title}`;
            document.getElementById('opponent-pokemon-name').textContent = opponentPokemon.name;
            document.getElementById('opponent-level').textContent = game.currentOpponent.level;
            document.getElementById('opponent-hp-display').textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
            document.getElementById('battle-opponent-sprite').src = opponentPokemon.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite'), game.currentOpponent.name, false);
            
            const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
            document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
            
            document.getElementById('battle-message').innerHTML = `${elite.name} desafia você!`;
            
            nextBattleQuestion();
          }
        } else {
          showScreen('map-screen');
          audioSystem.play('map-music');
          updatePlayerDisplay();
          updateGymAvailability();
          
          if (game.pendingEvolution) {
            setTimeout(() => startEvolution(), 500);
          }
        }
      } else {
        showScreen('starter-screen');
      }
    });

    const evolutionData = {
      bulbasaur: { evolvesTo: 'ivysaur', level: 16 },
      ivysaur: { evolvesTo: 'venusaur', level: 32 },
      charmander: { evolvesTo: 'charmeleon', level: 16 },
      charmeleon: { evolvesTo: 'charizard', level: 36 },
      squirtle: { evolvesTo: 'wartortle', level: 16 },
      wartortle: { evolvesTo: 'blastoise', level: 36 }
    };

    const pokemonData = {
      bulbasaur: { name: 'Bulbasaur', sprite: 'pokemon_assets/sprites_back/bulbasaur.gif', frontSprite: 'pokemon_assets/sprites_front/bulbasaur.gif', scale: 1.0 },
      ivysaur: { name: 'Ivysaur', sprite: 'pokemon_assets/sprites_back/ivysaur.gif', frontSprite: 'pokemon_assets/sprites_front/ivysaur.gif', scale: 1.4 },
      venusaur: { name: 'Venusaur', sprite: 'pokemon_assets/sprites_back/venusaur.gif', frontSprite: 'pokemon_assets/sprites_front/venusaur.gif', scale: 1.7 },
      charmander: { name: 'Charmander', sprite: 'pokemon_assets/sprites_back/charmander.gif', frontSprite: 'pokemon_assets/sprites_front/charmander.gif', scale: 1.0 },
      charmeleon: { name: 'Charmeleon', sprite: 'pokemon_assets/sprites_back/charmeleon.gif', frontSprite: 'pokemon_assets/sprites_front/charmeleon.gif', scale: 1.5 },
      charizard: { name: 'Charizard', sprite: 'pokemon_assets/sprites_back/charizard.gif', frontSprite: 'pokemon_assets/sprites_front/charizard.gif', scale: 2.9 },
      squirtle: { name: 'Squirtle', sprite: 'pokemon_assets/sprites_back/squirtle.gif', frontSprite: 'pokemon_assets/sprites_front/squirtle.gif', scale: 1.0 },
      wartortle: { name: 'Wartortle', sprite: 'pokemon_assets/sprites_back/wartortle.gif', frontSprite: 'pokemon_assets/sprites_front/wartortle.gif', scale: 1.3 },
      blastoise: { name: 'Blastoise', sprite: 'pokemon_assets/sprites_back/blastoise.gif', frontSprite: 'pokemon_assets/sprites_front/blastoise.gif', scale: 1.9 },
      geodude: { name: 'Geodude', sprite: 'pokemon_assets/sprites_front/geodude.gif', scale: 1.3, offsetY: 50 },
      // ZZZZ
      onix: { name: 'Onix', sprite: 'pokemon_assets/sprites_front/onix.gif', scale: 1.9 },
      staryu: { name: 'Staryu', sprite: 'pokemon_assets/sprites_front/staryu.gif', scale: 1.2 },
      starmie: { name: 'Starmie', sprite: 'pokemon_assets/sprites_front/starmie.gif', scale: 1.3 },
      voltorb: { name: 'Voltorb', sprite: 'pokemon_assets/sprites_front/voltorb.gif', scale: 0.7 },
      pikachu: { name: 'Pikachu', sprite: 'pokemon_assets/sprites_front/pikachu.gif', scale: 1.0 },
      raichu: { name: 'Raichu', sprite: 'pokemon_assets/sprites_front/raichu.gif', scale: 1.4 },
      victreebel: { name: 'Victreebel', sprite: 'pokemon_assets/sprites_front/victreebel.gif', scale: 1.5 },
      tangela: { name: 'Tangela', sprite: 'pokemon_assets/sprites_front/tangela.gif', scale: 1.0 },
      vileplume: { name: 'Vileplume', sprite: 'pokemon_assets/sprites_front/vileplume.gif', scale: 1.0 },
      koffing: { name: 'Koffing', sprite: 'pokemon_assets/sprites_front/koffing.gif', scale: 1.5 },
      muk: { name: 'Muk', sprite: 'pokemon_assets/sprites_front/muk.gif', scale: 1.4 },
      weezing: { name: 'Weezing', sprite: 'pokemon_assets/sprites_front/weezing.gif', scale: 1.6 },
      abra: { name: 'Abra', sprite: 'pokemon_assets/sprites_front/abra.gif', scale: 1.0 },
      kadabra: { name: 'Kadabra', sprite: 'pokemon_assets/sprites_front/kadabra.gif', scale: 1.2 },
      mrmime: { name: 'Mr. Mime', sprite: 'pokemon_assets/sprites_front/mr.mime.gif', scale: 1.2 },
      venomoth: { name: 'Venomoth', sprite: 'pokemon_assets/sprites_front/venomoth.gif', scale: 1.3 },
      alakazam: { name: 'Alakazam', sprite: 'pokemon_assets/sprites_front/alakazam.gif', scale: 1.3 },
      growlithe: { name: 'Growlithe', sprite: 'pokemon_assets/sprites_front/growlithe.gif', scale: 1.0 },
      ponyta: { name: 'Ponyta', sprite: 'pokemon_assets/sprites_front/ponyta.gif', scale: 1.1 },
      rapidash: { name: 'Rapidash', sprite: 'pokemon_assets/sprites_front/rapidash.gif', scale: 1.6 },
      arcanine: { name: 'Arcanine', sprite: 'pokemon_assets/sprites_front/arcanine.gif', scale: 1.0 },
      rhyhorn: { name: 'Rhyhorn', sprite: 'pokemon_assets/sprites_front/rhyhorn.gif', scale: 1.3 },
      dugtrio: { name: 'Dugtrio', sprite: 'pokemon_assets/sprites_front/dugtrio.gif', scale: 1.0 },
      nidoqueen: { name: 'Nidoqueen', sprite: 'pokemon_assets/sprites_front/nidoqueen.gif', scale: 1.4 },
      nidoking: { name: 'Nidoking', sprite: 'pokemon_assets/sprites_front/nidoking.gif', scale: 1.5 },
      rhydon: { name: 'Rhydon', sprite: 'pokemon_assets/sprites_front/rhydon.gif', scale: 1.5 },
      dewgong: { name: 'Dewgong', sprite: 'pokemon_assets/sprites_front/dewgong.gif', scale: 1.4 },
      cloyster: { name: 'Cloyster', sprite: 'pokemon_assets/sprites_front/cloyster.gif', scale: 1.4 },
      slowbro: { name: 'Slowbro', sprite: 'pokemon_assets/sprites_front/slowbro.gif', scale: 1.3 },
      jynx: { name: 'Jynx', sprite: 'pokemon_assets/sprites_front/jynx.gif', scale: 1.2 },
      lapras: { name: 'Lapras', sprite: 'pokemon_assets/sprites_front/lapras.gif', scale: 1.4 },
      hitmonchan: { name: 'Hitmonchan', sprite: 'pokemon_assets/sprites_front/hitmonchan.gif', scale: 1.2 },
      hitmonlee: { name: 'Hitmonlee', sprite: 'pokemon_assets/sprites_front/hitmonlee.gif', scale: 1.1 },
      machamp: { name: 'Machamp', sprite: 'pokemon_assets/sprites_front/machamp.gif', scale: 1.6 },
      gengar: { name: 'Gengar', sprite: 'pokemon_assets/sprites_front/gengar.gif', scale: 1.1 },
      golbat: { name: 'Golbat', sprite: 'pokemon_assets/sprites_front/golbat.gif', scale: 2.2 },
      haunter: { name: 'Haunter', sprite: 'pokemon_assets/sprites_front/haunter.gif', scale: 1.2 },
      arbok: { name: 'Arbok', sprite: 'pokemon_assets/sprites_front/arbok.gif', scale: 1.7 },
      gyarados: { name: 'Gyarados', sprite: 'pokemon_assets/sprites_front/gyarados.gif', scale: 1.9 },
      dragonair: { name: 'Dragonair', sprite: 'pokemon_assets/sprites_front/dragonair.gif', scale: 1.2 },
      aerodactyl: { name: 'Aerodactyl', sprite: 'pokemon_assets/sprites_front/aerodactyl.gif', scale: 2.5 },
      dragonite: { name: 'Dragonite', sprite: 'pokemon_assets/sprites_front/dragonite.gif', scale: 1.8 },
      pidgeot: { name: 'Pidgeot', sprite: 'pokemon_assets/sprites_front/pidgeot.gif', scale: 1.7 },
      exeggutor: { name: 'Exeggutor', sprite: 'pokemon_assets/sprites_front/exeggutor.gif', scale: 1.8 },
      rattata: { name: 'Rattata', sprite: 'pokemon_assets/sprites_front/rattata.gif', scale: 0.75 },
      raticate: { name: 'Raticate', sprite: 'pokemon_assets/sprites_front/raticate.gif', scale: 1.35 },
      spearow: { name: 'Spearow', sprite: 'pokemon_assets/sprites_front/spearow.gif', scale: 0.55 },
      fearow: { name: 'Fearow', sprite: 'pokemon_assets/sprites_front/fearow.gif', scale: 2.2 },
      ekans: { name: 'Ekans', sprite: 'pokemon_assets/sprites_front/ekans.gif', scale: 1.0 },
      sandshrew: { name: 'Sandshrew', sprite: 'pokemon_assets/sprites_front/sandshrew.gif', scale: 0.8 },
      sandslash: { name: 'Sandslash', sprite: 'pokemon_assets/sprites_front/sandslash.gif', scale: 1.2 },
      nidorina: { name: 'Nidorina', sprite: 'pokemon_assets/sprites_front/nidorina.gif', scale: 0.9 },
      nidorino: { name: 'Nidorino', sprite: 'pokemon_assets/sprites_front/nidorino.gif', scale: 0.9 },
      clefairy: { name: 'Clefairy', sprite: 'pokemon_assets/sprites_front/clefairy.gif', scale: 1.0 },
      vulpix: { name: 'Vulpix', sprite: 'pokemon_assets/sprites_front/vulpix.gif', scale: 0.75 },
      ninetales: { name: 'Ninetales', sprite: 'pokemon_assets/sprites_front/ninetales.gif', scale: 1.4 },
      jigglypuff: { name: 'Jigglypuff', sprite: 'pokemon_assets/sprites_front/jigglypuff.gif', scale: 0.7 },
      zubat: { name: 'Zubat', sprite: 'pokemon_assets/sprites_front/zubat.gif', scale: 1.5 },
      oddish: { name: 'Oddish', sprite: 'pokemon_assets/sprites_front/oddish.gif', scale: 0.75 },
      gloom: { name: 'Gloom', sprite: 'pokemon_assets/sprites_front/gloom.gif', scale: 0.8 },
      paras: { name: 'Paras', sprite: 'pokemon_assets/sprites_front/paras.gif', scale: 0.75 },
      parasect: { name: 'Parasect', sprite: 'pokemon_assets/sprites_front/parasect.gif', scale: 1.2 },
      venonat: { name: 'Venonat', sprite: 'pokemon_assets/sprites_front/venonat.gif', scale: 1.0 },
      diglett: { name: 'Diglett', sprite: 'pokemon_assets/sprites_front/diglett.gif', scale: 0.8 },
      meowth: { name: 'Meowth', sprite: 'pokemon_assets/sprites_front/meowth.gif', scale: 0.85 },
      persian: { name: 'Persian', sprite: 'pokemon_assets/sprites_front/persian.gif', scale: 1.1 },
      psyduck: { name: 'Psyduck', sprite: 'pokemon_assets/sprites_front/psyduck.gif', scale: 0.8 },
      golduck: { name: 'Golduck', sprite: 'pokemon_assets/sprites_front/golduck.gif', scale: 1.3 },
      mankey: { name: 'Mankey', sprite: 'pokemon_assets/sprites_front/mankey.gif', scale: 1.0 },
      primeape: { name: 'Primeape', sprite: 'pokemon_assets/sprites_front/primeape.gif', scale: 1.0 },
      poliwag: { name: 'Poliwag', sprite: 'pokemon_assets/sprites_front/poliwag.gif', scale: 0.7 },
      poliwhirl: { name: 'Poliwhirl', sprite: 'pokemon_assets/sprites_front/poliwhirl.gif', scale: 1.0 },
      bellsprout: { name: 'Bellsprout', sprite: 'pokemon_assets/sprites_front/bellsprout.gif', scale: 1.0 },
      weepinbell: { name: 'Weepinbell', sprite: 'pokemon_assets/sprites_front/weepinbell.gif', scale: 1.0 },
      zapdos: { name: 'Zapdos', sprite: 'pokemon_assets/sprites_front/zapdos.gif', scale: 1.6 },
      moltres: { name: 'Moltres', sprite: 'pokemon_assets/sprites_front/moltres.gif', scale: 2.2 },
      articuno: { name: 'Articuno', sprite: 'pokemon_assets/sprites_front/articuno.gif', scale: 2.4 },
      mewtwo: { name: 'Mewtwo', sprite: 'pokemon_assets/sprites_front/mewtwo.gif', scale: 1.8 },
      mew: { name: 'Mew', sprite: 'pokemon_assets/sprites_front/mew.gif', scale: 0.9 }
    };

    // ZZZZ  
    const trainingPokemon = ['rattata', 'raticate', 'spearow', 'fearow', 'ekans', 'sandshrew', 'sandslash', 'nidorina', 'nidorino', 'clefairy', 'vulpix', 'jigglypuff', 'zubat', 'oddish', 'gloom', 'paras', 'parasect', 'venonat', 'diglett', 'meowth', 'persian', 'psyduck', 'golduck', 'mankey', 'primeape', 'poliwag', 'poliwhirl', 'bellsprout', 'weepinbell'];

    const gyms = [
      { name: 'Brock', city: 'Pewter City', badge: 'Boulder Badge', requiredLevel: 10, pokemon: [{ name: 'geodude', level: 10 }, { name: 'onix', level: 14 }] },
      { name: 'Misty', city: 'Cerulean City', badge: 'Cascade Badge', requiredLevel: 18, pokemon: [{ name: 'staryu', level: 23 }, { name: 'starmie', level: 25 }] },
      { name: 'Lt. Surge', city: 'Vermilion City', badge: 'Thunder Badge', requiredLevel: 25, pokemon: [{ name: 'voltorb', level: 27 }, { name: 'pikachu', level: 30 }, { name: 'raichu', level: 33 }] },
      { name: 'Erika', city: 'Celadon City', badge: 'Rainbow Badge', requiredLevel: 30, pokemon: [{ name: 'victreebel', level: 33 }, { name: 'tangela', level: 35 }, { name: 'vileplume', level: 39 }] },
      { name: 'Koga', city: 'Fuchsia City', badge: 'Soul Badge', requiredLevel: 35, pokemon: [{ name: 'muk', level: 37 }, { name: 'koffing', level: 37 }, { name: 'weezing', level: 39 }, { name: 'venomoth', level: 43 }] },
      { name: 'Sabrina', city: 'Saffron City', badge: 'Marsh Badge', requiredLevel: 38, pokemon: [{ name: 'abra', level: 40 }, { name: 'kadabra', level: 42 }, { name: 'alakazam', level: 43 }] },
      { name: 'Blaine', city: 'Cinnabar Island', badge: 'Volcano Badge', requiredLevel: 42, pokemon: [{ name: 'growlithe', level: 42 }, { name: 'ponyta', level: 43 }, { name: 'rapidash', level: 45 }, { name: 'arcanine', level: 47 }, { name: 'ninetales', level: 50 }] },
      { name: 'Giovanni', city: 'Viridian City', badge: 'Earth Badge', requiredLevel: 45, pokemon: [{ name: 'dugtrio', level: 50 }, { name: 'persian', level: 53 }, { name: 'nidoqueen', level: 53 }, { name: 'nidoking', level: 55 }, { name: 'rhydon', level: 55 }] }
    ];

    const eliteFour = [
      { name: 'Lorelei', title: 'Mestre de Gelo', requiredLevel: 50, pokemon: [{ name: 'dewgong', level: 53 }, { name: 'cloyster', level: 55 }, { name: 'slowbro', level: 56 }, { name: 'jynx', level: 57 }, { name: 'lapras', level: 60 }] },
      { name: 'Bruno', title: 'Mestre de Luta', requiredLevel: 55, pokemon: [{ name: 'onix', level: 58 }, { name: 'hitmonchan', level: 61 }, { name: 'hitmonlee', level: 63 }, { name: 'onix', level: 66 }, { name: 'machamp', level: 68 }] },
      { name: 'Agatha', title: 'Mestre Fantasma', requiredLevel: 60, pokemon: [{ name: 'gengar', level: 66 }, { name: 'golbat', level: 67 }, { name: 'haunter', level: 67 }, { name: 'arbok', level: 68 }, { name: 'gengar', level: 70 }] },
      { name: 'Lance', title: 'Mestre de Dragões', requiredLevel: 75, pokemon: [{ name: 'gyarados', level: 77 }, { name: 'dragonair', level: 78 }, { name: 'dragonair', level: 80 }, { name: 'aerodactyl', level: 81 }, { name: 'dragonite', level: 85 }] },
      { name: 'Ash', title: 'Campeão Pokemon', requiredLevel: 100, pokemon: [{ name: 'pidgeot', level: 100 }, { name: 'zapdos', level: 100 }, { name: 'moltres', level: 100 }, { name: 'articuno', level: 100 }, { name: 'mewtwo', level: 100 }, { name: 'mew', level: 100 }] }
    ];

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if (screenId === 'map-screen') audioSystem.play('map-music');
    }

    function selectStarter(pokemon) {
      game.player.pokemon = pokemon;
      saveGame();
      updatePlayerDisplay();
      showScreen('map-screen');
      audioSystem.play('map-music');
      updateGymAvailability();
    }

    function healPokemon() {
      game.player.hp = game.player.maxHp;
      saveGame();
      updatePlayerDisplay();
      alert('Seu Pokemon foi curado completamente!');
    }

    function usePotion(battleType) {
      if (game.player.potions <= 0) {
        alert('Você não tem poções!');
        return;
      }
      
      if (game.player.hp === game.player.maxHp) {
        alert('Seu HP já está cheio!');
        return;
      }
      
      game.player.potions--;
      game.player.hp = game.player.maxHp;
      
      saveGame();
      
      if (battleType === 'training') {
        updateTrainingDisplay();
        document.getElementById('training-potion-count').textContent = game.player.potions;
      } else {
        updateBattleDisplay();
        document.getElementById('battle-potion-count').textContent = game.player.potions;
      }
      
      updatePlayerDisplay();
      
      const messageEl = document.getElementById(battleType === 'training' ? 'training-message' : 'battle-message');
      const originalBg = messageEl.style.background;
      messageEl.innerHTML = '🧪 Você usou uma Poção! HP restaurado completamente!';
      messageEl.style.background = 'rgba(0, 150, 255, 0.9)';
      
      setTimeout(() => {
        messageEl.style.background = originalBg;
      }, 2000);
    }

    function updatePlayerDisplay() {
      const data = pokemonData[game.player.pokemon];
      const spriteImg = document.getElementById('player-sprite');
      spriteImg.src = data.frontSprite;
      
      // Remove todas as classes de tamanho primeiro
      spriteImg.classList.remove('starter-small', 'mid-small', 'final-small');
      
      // Define os grupos de tamanho
      const starterSmall = ['bulbasaur', 'charmander', 'squirtle'];
      const midSmall = ['ivysaur', 'charmeleon', 'wartortle'];
      const finalSmall = ['venusaur', 'charizard', 'blastoise'];
      
      // Adiciona a classe apropriada
      if (starterSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('starter-small');
      } else if (midSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('mid-small');
      } else if (finalSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('final-small');
      }
      
      applyPokemonScale(spriteImg, game.player.pokemon, 1.0);
      document.getElementById('player-pokemon-name').textContent = data.name;
      document.getElementById('player-level').textContent = game.player.level;
      document.getElementById('hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      document.getElementById('exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      document.getElementById('potion-count').textContent = game.player.potions;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      document.getElementById('hp-bar').style.width = hpPercent + '%';
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('exp-bar').style.width = expPercent + '%';

      game.player.badges.forEach(badgeIndex => {
        document.getElementById(`badge-${badgeIndex}`).classList.add('earned');
      });
    }

    function applyPokemonScale(imgElement, pokemonName, maxScale = null, offsetX = null, offsetY = null) {
      const data = pokemonData[pokemonName];
      if (data && data.scale) {
        let finalScale = data.scale;
        
        if (maxScale !== null && finalScale > maxScale) {
          finalScale = maxScale;
        }
        
        if (offsetX !== null && offsetY !== null) {
          imgElement.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${finalScale})`;
        } else {
          imgElement.style.transform = `scale(${finalScale})`;
        }
      }
    }

    function applyPokemonScaleInBattle(imgElement, pokemonName, isPlayer = true) {
      const data = pokemonData[pokemonName];
      const scale = data && data.scale ? data.scale : 1;
      const offsetY = data && data.offsetY ? data.offsetY : 0;
      
      imgElement.style.transformOrigin = 'bottom center';
      imgElement.style.transform = `translateY(${offsetY}px) scale(${scale})`;
    }

    function updateGymAvailability() {
      gyms.forEach((gym, index) => {
        const gymEl = document.getElementById(`gym-${index}`);
        const hasRequiredBadges = game.player.badges.length >= index;
        
        gymEl.classList.remove('completed', 'locked');
        
        if (game.player.badges.includes(index)) {
          gymEl.classList.add('completed');
        } else if (hasRequiredBadges && game.player.level >= gym.requiredLevel) {
          // Disponível
        } else {
          gymEl.classList.add('locked');
        }
      });

      if (game.player.badges.length === 8) {
        document.getElementById('elite-section').style.display = 'block';
        updateEliteAvailability();
      }
    }

    function updateEliteAvailability() {
      eliteFour.forEach((elite, index) => {
        const eliteEl = document.getElementById(`elite-${index}`);
        const hasRequiredElite = game.player.eliteDefeated.length >= index;
        
        if (game.player.eliteDefeated.includes(index)) {
          eliteEl.classList.add('completed');
          eliteEl.classList.remove('locked');
        } else if (hasRequiredElite && game.player.level >= elite.requiredLevel) {
          eliteEl.classList.remove('locked');
        } else {
          eliteEl.classList.add('locked');
        }
      });
    }

    function calculatePokemonHP(level, type) {
      let increment;
      if (type === 'player') increment = 5;
      else if (type === 'gym') increment = 7;
      else if (type === 'elite') increment = 10;
      else if (type === 'ash') increment = 15;
      
      return 15 + ((level - 1) * increment);
    }

    function startTraining() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      const randomPokemon = trainingPokemon[Math.floor(Math.random() * trainingPokemon.length)];
      const level = Math.min(100, Math.max(1, game.player.level - 2 + Math.floor(Math.random() * 5)));
      
      game.trainingOpponent = {
        name: randomPokemon,
        level: level,
        maxHp: 20 + (level * 3),
        hp: 20 + (level * 3)
      };

      game.inBattle = true;
      game.battleType = 'training';

      showScreen('training-screen');
      audioSystem.play('training-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('training-player-sprite').src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('training-player-sprite'), game.player.pokemon, true);
      document.getElementById('training-pokemon-name').textContent = playerData.name;
      document.getElementById('training-level').textContent = game.player.level;
      
      const opponentData = pokemonData[randomPokemon];
      document.getElementById('training-opponent-name').textContent = 'Pokemon Selvagem';
      document.getElementById('training-opponent-pokemon-name').textContent = opponentData.name;
      document.getElementById('training-opponent-level').textContent = level;
      document.getElementById('training-opponent-sprite').src = opponentData.sprite;
      applyPokemonScaleInBattle(document.getElementById('training-opponent-sprite'), randomPokemon, false);
      
      updateTrainingDisplay();
      nextTrainingQuestion();

      document.getElementById('training-potion-count').textContent = game.player.potions;
    }

    function updateTrainingDisplay() {
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('training-exp-bar').style.width = expPercent + '%';
      document.getElementById('training-exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      document.getElementById('training-level').textContent = game.player.level;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      document.getElementById('training-battle-hp-bar').style.width = hpPercent + '%';
      document.getElementById('training-battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      if (game.trainingOpponent) {
        const oppHpPercent = (game.trainingOpponent.hp / game.trainingOpponent.maxHp) * 100;
        document.getElementById('training-opponent-hp-bar').style.width = oppHpPercent + '%';
        document.getElementById('training-opponent-hp-display').textContent = `${game.trainingOpponent.hp}/${game.trainingOpponent.maxHp}`;
      }
    }

    function nextTrainingQuestion() {
      if (!currentTrainingQuestion) {
        currentTrainingQuestion = generateQuestion();
      }
      
      updateQuestionCounter();
      document.getElementById('training-question').innerHTML = currentTrainingQuestion.question;
      
      const answersDiv = document.getElementById('training-answers');
      answersDiv.innerHTML = '';
      currentTrainingQuestion.allAnswers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.onclick = () => checkTrainingAnswer(ans, currentTrainingQuestion.answer, currentTrainingQuestion.index);
        answersDiv.appendChild(btn);
      });
    }

    function checkTrainingAnswer(selected, correct, questionIndex) {
      const messageEl = document.getElementById('training-message');
      const answersDiv = document.getElementById('training-answers');
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      saveGame();
      
      if(selected === correct) {
        markQuestionAsAnswered(questionIndex);
        updateQuestionCounter();
        
        const damage = 8 + Math.floor(game.player.level * 1.2);
        messageEl.innerHTML = `✅ CORRETO! ${pokemonData[game.player.pokemon].name} vai atacar e causar ${damage} de dano!<br><br><strong>Resposta: ${correct}</strong><br><br><button onclick="continueAfterCorrectTraining(${damage})" class="btn-secondary" style="margin-top: 10px;">Continuar</button>`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
      } else {
        messageEl.innerHTML = `❌ ERRADO! A resposta correta era:<br><br><strong>${correct}</strong><br><br><button onclick="continueAfterWrongTraining()" class="btn-primary" style="margin-top: 10px;">Continuar</button>`;
        messageEl.style.background = 'rgba(200, 0, 0, 0.9)';
      }

      document.getElementById('training-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function continueAfterCorrectTraining(damage) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const messageEl = document.getElementById('training-message');
      const answersDiv = document.getElementById('training-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        game.trainingOpponent.hp = Math.max(0, game.trainingOpponent.hp - damage);
        messageEl.innerHTML = `${pokemonData[game.player.pokemon].name} atacou!`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
        updateTrainingDisplay();
        currentTrainingQuestion = null;
        
        if(game.trainingOpponent.hp <= 0) {
          showBattleResult(true, '🎉 VITÓRIA! 🎉', `Você derrotou ${pokemonData[game.trainingOpponent.name].name}!`);
          
          setTimeout(() => {
            if(game.player.level < 100) {
              const expGain = 20 + Math.floor(game.trainingOpponent.level * 3);
              game.player.exp += expGain;
              messageEl.innerHTML = `🎉 VITÓRIA! ${pokemonData[game.player.pokemon].name} ganhou ${expGain} EXP!`;
              
              if(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                game.player.level++;
                game.player.exp = 0;
                if(game.player.level >= 100) {
                  game.player.expToNext = 0;
                } else {
                  game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                }
                game.player.maxHp += 5;
                game.player.hp = game.player.maxHp;
                messageEl.innerHTML += `<br>🎉 LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o nível ${game.player.level}!`;
                
                if (checkEvolution()) {
                  messageEl.innerHTML += `<br>✨ ${pokemonData[game.player.pokemon].name} está pronto para evoluir!`;
                }
                
                updatePlayerDisplay();
                updateGymAvailability();
              }
            } else {
              messageEl.innerHTML = `🎉 VITÓRIA! ${pokemonData[game.player.pokemon].name} está no nível máximo!`;
            }
            
            saveGame();
            updateTrainingDisplay();
            
            setTimeout(() => {
              messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
              messageEl.innerHTML = 'Treinamento concluído! Voltando ao mapa...';
              if (Math.random() < 0.25) {
                game.player.potions++;
                messageEl.innerHTML += '<br>🎁 Você ganhou uma Poção!';
                saveGame();
              }
              setTimeout(() => backToMap(), 2000);
            }, 2000);
          }, 3500);
          return;
        }
        
        setTimeout(() => {
          trainingOpponentAttack();
        }, 1000);
      }, 300);
    }

    function continueAfterWrongTraining() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const answersDiv = document.getElementById('training-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        trainingOpponentAttack();
      }, 300);
    }

    function trainingOpponentAttack() {

      // ADICIONAR ESTAS LINHAS NO INÍCIO:
      document.getElementById('training-potion-btn').disabled = true;
      document.querySelectorAll('#training-screen button').forEach(btn => {
        if(btn.textContent.includes('Voltar ao Mapa')) btn.disabled = true;
      });

      const messageEl = document.getElementById('training-message');
      const damage = 3 + Math.floor(game.trainingOpponent.level * 0.8);
      game.player.hp = Math.max(0, game.player.hp - damage);
      
      messageEl.innerHTML = `${pokemonData[game.trainingOpponent.name].name} atacou e causou ${damage} de dano!`;
      messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
      
      updateTrainingDisplay();
      
      saveGame();
      
      if(game.player.hp <= 0) {
        showBattleResult(false, '💀 DERROTA! 💀', `${pokemonData[game.player.pokemon].name} foi derrotado!`);
        
        setTimeout(() => {
          messageEl.innerHTML = `💀 ${pokemonData[game.player.pokemon].name} foi derrotado!<br>Você voltou ao Centro Pokemon...`;
          game.player.hp = game.player.maxHp;
          saveGame();
          currentTrainingQuestion = null;
          
          setTimeout(() => backToMap(), 3000);
        }, 3500);
        return;
      }
      
      setTimeout(() => {
        messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
        currentTrainingQuestion = null;

        // ADICIONAR ESTAS LINHAS ANTES DE nextTrainingQuestion():
        document.getElementById('training-potion-btn').disabled = false;
        document.querySelectorAll('#training-screen button').forEach(btn => {
          if(btn.textContent.includes('Voltar ao Mapa')) btn.disabled = false;
        });

        nextTrainingQuestion();
      }, 1500);
    }

    function backToMap() {
      const trainingMessage = document.getElementById('training-message');
      if (trainingMessage) {
        trainingMessage.innerHTML = 'Responda corretamente para atacar o Pokemon selvagem!';
        trainingMessage.style.background = 'rgba(0, 0, 0, 0.9)';
      }
      
      game.inBattle = false;
      game.currentGym = null;
      game.currentElite = null;
      game.currentOpponent = null;
      game.trainingOpponent = null;
      currentTrainingQuestion = null;
      currentBattleQuestion = null;
      
      saveGame();
      
      showScreen('map-screen');
      audioSystem.play('map-music');
      updatePlayerDisplay();
      updateGymAvailability();
      
      if (game.pendingEvolution) {
        setTimeout(() => startEvolution(), 500);
      }
    }

    function challengeGym(gymIndex) {
      const gym = gyms[gymIndex];
      const gymEl = document.getElementById(`gym-${gymIndex}`);
      
      if(gymEl.classList.contains('locked')) {
        alert(`Você precisa estar no nível ${gym.requiredLevel} ou superior para desafiar este ginásio!`);
        return;
      }
      
      if(game.player.badges.includes(gymIndex)) {
        alert('Você já conquistou este ginásio!');
        return;
      }
      
      game.currentGym = gymIndex;
      game.battleType = 'gym';
      
      const pokemonWithHP = gym.pokemon.map(p => {
        const hp = calculatePokemonHP(p.level, 'gym');
        return { ...p, maxHp: hp, hp: hp };
      });
      
      game.currentOpponent = { ...pokemonWithHP[0] };
      game.currentOpponent.index = 0;
      game.currentOpponent.allPokemon = pokemonWithHP;
      game.inBattle = true;
      
      startBattle(gym);
    }

    function challengeElite(eliteIndex) {
      const elite = eliteFour[eliteIndex];
      const eliteEl = document.getElementById(`elite-${eliteIndex}`);
      
      if(eliteEl.classList.contains('locked')) {
        alert(`Você precisa estar no nível ${elite.requiredLevel} ou superior!`);
        return;
      }

      if(eliteIndex === 4 && game.player.level < 100) {
        alert('Você precisa estar no nível 100 para desafiar o Ash, atual campeão!');
        return;
      }
      
      if(game.player.eliteDefeated.includes(eliteIndex)) {
        alert('Você já derrotou este membro da Elite Four!');
        return;
      }
      
      game.currentElite = eliteIndex;
      game.battleType = 'elite';
      
      const hpType = eliteIndex === 4 ? 'ash' : 'elite';
      const pokemonWithHP = elite.pokemon.map(p => {
        const hp = calculatePokemonHP(p.level, hpType);
        return { ...p, maxHp: hp, hp: hp };
      });
      
      game.currentOpponent = { ...pokemonWithHP[0] };
      game.currentOpponent.index = 0;
      game.currentOpponent.allPokemon = pokemonWithHP;
      game.inBattle = true;
      
      startEliteBattle(elite);
    }

    function startBattle(gym) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      showScreen('battle-screen');
      audioSystem.play('gym-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('battle-player-sprite').src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-player-sprite'), game.player.pokemon, true);
      document.getElementById('battle-player-name').textContent = playerData.name;
      document.getElementById('battle-player-level').textContent = game.player.level;
      document.getElementById('battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      document.getElementById('battle-hp-bar').style.width = hpPercent + '%';
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar').style.width = expPercent + '%';
      document.getElementById('battle-exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      
      const opponentPokemon = pokemonData[game.currentOpponent.name];
      document.getElementById('opponent-name').textContent = `Líder ${gym.name}`;
      document.getElementById('opponent-pokemon-name').textContent = opponentPokemon.name;
      document.getElementById('opponent-level').textContent = game.currentOpponent.level;
      document.getElementById('opponent-hp-display').textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      document.getElementById('battle-opponent-sprite').src = opponentPokemon.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite'), game.currentOpponent.name, false);
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
      
      document.getElementById('battle-message').innerHTML = `${gym.name} desafia você para uma batalha!`;
      
      nextBattleQuestion();

      document.getElementById('battle-potion-count').textContent = game.player.potions;
    }

    function startEliteBattle(elite) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      showScreen('battle-screen');
      audioSystem.play('elite-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('battle-player-sprite').src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-player-sprite'), game.player.pokemon, true);
      document.getElementById('battle-player-name').textContent = playerData.name;
      document.getElementById('battle-player-level').textContent = game.player.level;
      document.getElementById('battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      document.getElementById('battle-hp-bar').style.width = hpPercent + '%';
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar').style.width = expPercent + '%';
      document.getElementById('battle-exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      
      const opponentPokemon = pokemonData[game.currentOpponent.name];
      document.getElementById('opponent-name').textContent = `${elite.name} - ${elite.title}`;
      document.getElementById('opponent-pokemon-name').textContent = opponentPokemon.name;
      document.getElementById('opponent-level').textContent = game.currentOpponent.level;
      document.getElementById('opponent-hp-display').textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      document.getElementById('battle-opponent-sprite').src = opponentPokemon.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite'), game.currentOpponent.name, false);
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
      
      document.getElementById('battle-message').innerHTML = `${elite.name} desafia você!`;
      
      nextBattleQuestion();

      document.getElementById('battle-potion-count').textContent = game.player.potions;
    }

    function nextBattleQuestion() {
      if (!currentBattleQuestion) {
        currentBattleQuestion = generateQuestion();
      }
      
      updateQuestionCounter();
      document.getElementById('battle-question').innerHTML = currentBattleQuestion.question;
      
      const answersDiv = document.getElementById('battle-answers');
      answersDiv.innerHTML = '';
      currentBattleQuestion.allAnswers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.onclick = () => checkBattleAnswer(ans, currentBattleQuestion.answer, currentBattleQuestion.index);
        answersDiv.appendChild(btn);
      });
    }

    function checkBattleAnswer(selected, correct, questionIndex) {
      saveGame();
      
      const messageEl = document.getElementById('battle-message');
      
      if (game.battleType === 'gym') {
        const gym = gyms[game.currentGym];
        handleBattleLogic(selected, correct, gym, gym.pokemon, 'badges', game.currentGym, questionIndex);
      } else {
        const elite = eliteFour[game.currentElite];
        handleBattleLogic(selected, correct, elite, elite.pokemon, 'eliteDefeated', game.currentElite, questionIndex);
      }
    }

    function handleBattleLogic(selected, correct, opponent, pokemonList, progressType, progressIndex, questionIndex) {
      const messageEl = document.getElementById('battle-message');
      
      if(selected === correct) {
        const answersDiv = document.getElementById('battle-answers');
        answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        markQuestionAsAnswered(questionIndex);
        updateQuestionCounter();
        
        const damage = 10 + Math.floor(game.player.level * 1.5);
        messageEl.innerHTML = `✅ CORRETO! ${pokemonData[game.player.pokemon].name} vai atacar e causar ${damage} de dano!<br><br><strong>Resposta: ${correct}</strong><br><br><button onclick="continueAfterCorrectBattle(${damage}, '${progressType}', ${progressIndex})" class="btn-secondary" style="margin-top: 10px;">Continuar</button>`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';

        document.getElementById('battle-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        saveGame();
        
      } else {
        const answersDiv = document.getElementById('battle-answers');
        answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        messageEl.innerHTML = `❌ ERRADO! A resposta correta era:<br><br><strong>${correct}</strong><br><br><button onclick="continueAfterWrongBattle()" class="btn-primary" style="margin-top: 10px;">Continuar</button>`;
        messageEl.style.background = 'rgba(200, 0, 0, 0.9)';

        document.getElementById('battle-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function continueAfterWrongBattle() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const answersDiv = document.getElementById('battle-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        opponentAttack();
      }, 300);
    }

    function continueAfterCorrectBattle(damage, progressType, progressIndex) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const messageEl = document.getElementById('battle-message');
      const answersDiv = document.getElementById('battle-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        game.currentOpponent.hp = Math.max(0, game.currentOpponent.hp - damage);
        messageEl.innerHTML = `${pokemonData[game.player.pokemon].name} atacou!`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
        
        updateBattleDisplay();
        saveGame();
        
        const opponent = game.battleType === 'gym' ? gyms[game.currentGym] : eliteFour[game.currentElite];
        const pokemonList = game.currentOpponent.allPokemon;
        
        if(game.currentOpponent.hp <= 0) {
          const defeatedPokemonIndex = game.currentOpponent.index;
          game.currentOpponent.index++;
          
          if(game.currentOpponent.index < pokemonList.length) {
            const defeatedPokemon = pokemonList[defeatedPokemonIndex];
            
            let leveledUp = false;
            if(game.player.level < 100) {
              const expGain = 15 + Math.floor(defeatedPokemon.level * 6);
              game.player.exp += expGain;

              while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                game.player.level++;
                game.player.exp -= game.player.expToNext;
                if(game.player.level >= 100) {
                  game.player.expToNext = 0;
                } else {
                  game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                }
                game.player.maxHp += 5;
                leveledUp = true;
              }

              if (leveledUp) {
                game.player.hp = game.player.maxHp;
                checkEvolution();
              }
            }

            updateBattleDisplay();
            saveGame();
            
            setTimeout(() => {
              if(game.player.level < 100) {
                const expGain = 15 + Math.floor(defeatedPokemon.level * 6);
                messageEl.innerHTML = `${pokemonData[defeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} ganhou ${expGain} EXP!`;
                if (leveledUp) {
                  messageEl.innerHTML += `<br>🎉 LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o nível ${game.player.level}!`;
                }
              } else {
                messageEl.innerHTML = `${pokemonData[defeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} está no nível máximo!`;
              }
              messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
              
              setTimeout(() => {
                currentBattleQuestion = null;
                const nextPokemonIndex = game.currentOpponent.index;
                game.currentOpponent = { ...pokemonList[nextPokemonIndex] };
                game.currentOpponent.index = nextPokemonIndex;
                game.currentOpponent.allPokemon = pokemonList;
                
                messageEl.innerHTML = `${opponent.name} enviou ${pokemonData[game.currentOpponent.name].name}!`;
                messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
                
                saveGame();
                
                if (game.battleType === 'gym') {
                  startBattle(opponent);
                } else {
                  startEliteBattle(opponent);
                }

                setTimeout(() => {
                  applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite'), game.currentOpponent.name, false);
                }, 100);
                
              }, 3500);
            }, 1500);
            
            return;
          } else {
            const lastDefeatedPokemon = pokemonList[defeatedPokemonIndex];
            
            showBattleResult(true, '🏆 VITÓRIA COMPLETA! 🏆', `Você derrotou ${opponent.name}!`);
            
            setTimeout(() => {
              let leveledUp = false;
              
              if(game.player.level < 100) {
                const lastExpGain = 15 + Math.floor(lastDefeatedPokemon.level * 6);
                game.player.exp += lastExpGain;
                
                while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                  game.player.level++;
                  game.player.exp -= game.player.expToNext;
                  if(game.player.level >= 100) {
                    game.player.expToNext = 0;
                  } else {
                    game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                  }
                  game.player.maxHp += 5;
                  leveledUp = true;
                }
                
                if (leveledUp) {
                  game.player.hp = game.player.maxHp;
                  checkEvolution();
                }
              }
              
              updateBattleDisplay();
              saveGame();
              
              if(game.player.level < 100) {
                const lastExpGain = 15 + Math.floor(lastDefeatedPokemon.level * 6);
                messageEl.innerHTML = `${pokemonData[lastDefeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} ganhou ${lastExpGain} EXP!`;
                if (leveledUp) {
                  messageEl.innerHTML += `<br>🎉 LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o nível ${game.player.level}!`;
                }
              } else {
                messageEl.innerHTML = `${pokemonData[lastDefeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} está no nível máximo!`;
              }
              messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
              
              setTimeout(() => {
                game.player[progressType].push(progressIndex);
                
                let leveledUpBonus = false;

                if(game.player.level < 100) {
                  const expBonus = progressType === 'badges' ? 100 + (progressIndex * 50) : 200 + (progressIndex * 100);
                  game.player.exp += expBonus;

                  while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                    game.player.level++;
                    game.player.exp -= game.player.expToNext;
                    if(game.player.level >= 100) {
                      game.player.expToNext = 0;
                    } else {
                      game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                    }
                    game.player.maxHp += 5;
                    leveledUpBonus = true;
                  }
                }
                
                game.player.hp = game.player.maxHp;
                
                if (leveledUpBonus) {
                  checkEvolution();
                }
                
                updateBattleDisplay();
                saveGame();
                currentBattleQuestion = null;
                
                if (progressType === 'eliteDefeated' && progressIndex === 4) {
                  showScreen('victory-screen');
                  audioSystem.stopAll();
                } else {
                  const badge = progressType === 'badges' ? opponent.badge : `${opponent.name} derrotado`;
                  if(game.player.level < 100) {
                    const expBonus = progressType === 'badges' ? 100 + (progressIndex * 50) : 200 + (progressIndex * 100);
                    messageEl.innerHTML = `🏆 VITÓRIA COMPLETA! Você conquistou ${badge}!<br>Ganhou ${expBonus} EXP de bônus!`;
                    if (leveledUpBonus) {
                      messageEl.innerHTML += `<br>🎉 LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o nível ${game.player.level}!`;
                    }
                  } else {
                    messageEl.innerHTML = `🏆 VITÓRIA COMPLETA! Você conquistou ${badge}!<br>${pokemonData[game.player.pokemon].name} está no nível máximo!`;
                  }
                  messageEl.style.background = 'rgba(255, 215, 0, 0.9)';
                  
                  setTimeout(() => {
                    game.inBattle = false;
                    backToMap();
                  }, 3000);
                }
              }, 2000);
            }, 3500);
            return;
          }
        }
        
        setTimeout(() => opponentAttack(), 1500);
      }, 300);
    }

    function opponentAttack() {
      
      // ADICIONAR ESTAS LINHAS NO INÍCIO:
      document.getElementById('battle-potion-btn').disabled = true;

      const messageEl = document.getElementById('battle-message');
      const damage = 5 + Math.floor(game.currentOpponent.level);
      game.player.hp = Math.max(0, game.player.hp - damage);
      currentBattleQuestion = null;
      
      messageEl.innerHTML = `${pokemonData[game.currentOpponent.name].name} atacou e causou ${damage} de dano!`;
      messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
      
      updateBattleDisplay();
      
      saveGame();
      
      if(game.player.hp <= 0) {
        showBattleResult(false, '💀 DERROTA! 💀', `${pokemonData[game.player.pokemon].name} foi derrotado!`);
        
        setTimeout(() => {
          messageEl.innerHTML = `💀 ${pokemonData[game.player.pokemon].name} foi derrotado!<br>Você voltou ao Centro Pokemon...`;
          game.player.hp = game.player.maxHp;
          game.inBattle = false;
          saveGame();
          
          setTimeout(() => backToMap(), 3000);
        }, 3500);
        return;
      }
      
      setTimeout(() => {
        messageEl.style.background = 'rgba(0, 0, 0, 0.9)';

        // ADICIONAR ESTA LINHA ANTES DE nextBattleQuestion():
        document.getElementById('battle-potion-btn').disabled = false;

        nextBattleQuestion();
      }, 1500);
    }

    function updateBattleDisplay() {
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      document.getElementById('battle-hp-bar').style.width = hpPercent + '%';
      document.getElementById('battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      document.getElementById('opponent-hp-bar').style.width = oppHpPercent + '%';
      document.getElementById('opponent-hp-display').textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar').style.width = expPercent + '%';
      document.getElementById('battle-exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
    }

    let audioUnlocked = false;
    document.addEventListener('click', function unlockAudio() {
      if (!audioUnlocked) {
        audioUnlocked = true;
        if (audioSystem.currentAudio) {
          const audio = document.getElementById(audioSystem.currentAudio);
          if (audio && audio.paused) {
            audio.play().catch(() => {});
          }
        } else {
          const mapScreen = document.getElementById('map-screen');
          if (mapScreen && mapScreen.classList.contains('active')) {
            audioSystem.play('map-music');
          }
        }
      }
    }, { once: true });

    function exportSave() {
      const saveData = localStorage.getItem('pokemonYellowSave');
      const usedQuestions = localStorage.getItem('pokemonYellowUsedQuestions');
      
      if (!saveData) {
        alert('Nenhum progresso para exportar!');
        return;
      }
      
      const exportData = {
        save: saveData,
        questions: usedQuestions
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'pokemonsave.txt';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert('Save exportado com sucesso! Arquivo: pokemonsave.txt');
    }

    function importSave() {
      document.getElementById('file-input').click();
    }

    function loadSaveFile(event) {
      const file = event.target.files[0];
      
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (importData.save) {
            localStorage.setItem('pokemonYellowSave', importData.save);
          }
          
          if (importData.questions) {
            localStorage.setItem('pokemonYellowUsedQuestions', importData.questions);
          }
          
          alert('Save importado com sucesso! A página será recarregada.');
          location.reload();
          
        } catch (error) {
          alert('Erro ao importar save! Arquivo inválido.');
        }
      };
      
      reader.readAsText(file);
      
      event.target.value = '';
    }
  </script>
</body>
</html>
